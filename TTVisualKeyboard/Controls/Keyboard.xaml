<UserControl x:Class="TTVisualKeyboard.Views.Keyboard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:TTVisualKeyboard.ViewModels"
             xmlns:conv="clr-namespace:TTVisualKeyboard.Converters"
             x:Name="Root">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/TTVisualKeyboard;component/Themes/KeyboardTheme.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!-- Make inactive modifier labels more visible (not too faint) -->
            <conv:BoolToOpacityConverter x:Key="BoolToOpacity" TrueOpacity="1.0" FalseOpacity="0.6"/>
            <conv:StringNullOrEmptyToVisibilityConverter x:Key="NullOrEmptyToVisibility"
                                                         EmptyVisibility="Collapsed"
                                                         NonEmptyVisibility="Visible"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <ItemsControl x:Name="KeyboardItems" ItemsSource="{Binding AllKeys}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Grid />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemContainerStyle>
                <Style TargetType="ContentPresenter">
                    <Setter Property="Grid.Row" Value="{Binding Row}"/>
                    <Setter Property="Grid.Column" Value="{Binding Column}"/>
                    <Setter Property="Grid.RowSpan" Value="{Binding RowSpan}"/>
                    <Setter Property="Grid.ColumnSpan" Value="{Binding ColSpan}"/>
                </Style>
            </ItemsControl.ItemContainerStyle>

            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:KeyViewModel}">
                    <Border Style="{StaticResource KeyStyle}" AutomationProperties.Name="{Binding LabelPrimary}">
                        <!-- 3x3 layout: small modifiers in top corners, primary centered -->
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Shift (top-left) -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="{Binding LabelShift}"
                                       Style="{StaticResource SmallLabelStyle}"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="NoWrap"
                                       HorizontalAlignment="Left"
                                       VerticalAlignment="Top"
                                       Visibility="{Binding LabelShift, Converter={StaticResource NullOrEmptyToVisibility}}"
                                       Opacity="{Binding DataContext.IsShiftActive, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource BoolToOpacity}}"/>

                            <!-- AltGr (top-right) -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                       Text="{Binding LabelAltGr}"
                                       Style="{StaticResource SmallLabelStyle}"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="NoWrap"
                                       HorizontalAlignment="Right"
                                       VerticalAlignment="Top"
                                       Visibility="{Binding LabelAltGr, Converter={StaticResource NullOrEmptyToVisibility}}"
                                       Opacity="{Binding DataContext.IsAltGrActive, RelativeSource={RelativeSource AncestorType=ItemsControl}, Converter={StaticResource BoolToOpacity}}"/>

                            <!-- Primary label (center) -->
                            <TextBlock Grid.Row="1" Grid.Column="1"
                                       Text="{Binding LabelPrimary}"
                                       FontWeight="SemiBold"
                                       FontSize="12"
                                       TextTrimming="CharacterEllipsis"
                                       TextWrapping="Wrap"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontSize" Value="12"/>
                                        <Setter Property="VerticalAlignment" Value="Center"/>
                                        <Setter Property="TextWrapping" Value="Wrap"/>
                                        <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                        <Style.Triggers>
                                            <!-- Numpad Enter: Column == 24 -->
                                            <DataTrigger Binding="{Binding Column}" Value="24">
                                                <Setter Property="FontSize" Value="10"/>
                                                <Setter Property="VerticalAlignment" Value="Top"/>
                                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                                <Setter Property="Margin" Value="0,4,0,0"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                        </Grid>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</UserControl>
